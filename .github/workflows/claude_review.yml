name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  auto_review:
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Configure Git Credentials
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@users.noreply.github.com"
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Run Claude Code Action (documentation pass)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          auto_approve_writes: '*'
          prompt: |
            You are the documentation-focused Claude reviewer.
            - Read the diff to understand the intent of the code changes but DO NOT modify source code, configuration, or tests.
            - Update only documentation assets (Markdown, docs/, *.mdx) so they stay accurate with the latest implementation details.
            - If you discover code bugs or security issues, summarize them in review comments and clearly request that `@cursor verify` be invoked to fix them.
            - Provide a concise summary of the documentation updates you made.

      - name: Commit and Push Documentation Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@users.noreply.github.com"

          # Configure git to use the token for authentication
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          CHANGED_FILES="$(git status --porcelain)"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected."
            exit 0
          fi

          ALLOWED_REGEX='(\.md$|\.mdx$|\.rst$|^docs/)'
          NON_DOC_FILES="$(echo "$CHANGED_FILES" | awk '{print $2}' | grep -Ev "$ALLOWED_REGEX" || true)"
          if [ -n "$NON_DOC_FILES" ]; then
            echo "Non-documentation changes detected:"
            echo "$NON_DOC_FILES"
            echo "Refusing to commit so Cursor can handle code changes."
            exit 1
          fi

          DOC_FILES="$(echo "$CHANGED_FILES" | awk '{print $2}' | grep -E "$ALLOWED_REGEX" | sort -u)"
          if [ -z "$DOC_FILES" ]; then
            echo "No documentation files to commit."
            exit 0
          fi

          echo "$DOC_FILES" | xargs git add
          if ! git diff --staged --quiet; then
            git commit -m "docs: sync documentation with PR changes"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No documentation changes to commit."
          fi

  comment_review:
    if: >-
      ${{ github.event_name == 'issue_comment' &&
          contains(github.event.comment.body, '@claude') &&
          github.event.issue.pull_request != null }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Checkout PR Branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr checkout ${{ github.event.issue.number }}

      - name: Configure Git Credentials
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@users.noreply.github.com"
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

      - name: Run Claude Code Action (comment-triggered docs)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          auto_approve_writes: '*'
          prompt: |
            You are responding as the documentation-only Claude reviewer.
            - Fulfill the user's request only if it requires documentation updates (Markdown, docs/, *.mdx).
            - Do NOT modify application code, configuration, or tests.
            - If the request involves bug fixes or security work, leave review comments explaining the findings and instruct the author to mention `@cursor verify` for implementation help.
            - Summarize the documentation adjustments you perform.

      - name: Commit and Push Documentation Changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "Claude Bot"
          git config --global user.email "claude-bot@users.noreply.github.com"

          # Configure git to use the token for authentication
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          CHANGED_FILES="$(git status --porcelain)"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected."
            exit 0
          fi

          ALLOWED_REGEX='(\.md$|\.mdx$|\.rst$|^docs/)'
          NON_DOC_FILES="$(echo "$CHANGED_FILES" | awk '{print $2}' | grep -Ev "$ALLOWED_REGEX" || true)"
          if [ -n "$NON_DOC_FILES" ]; then
            echo "Non-documentation changes detected:"
            echo "$NON_DOC_FILES"
            echo "Refusing to commit so Cursor can handle code changes."
            exit 1
          fi

          DOC_FILES="$(echo "$CHANGED_FILES" | awk '{print $2}' | grep -E "$ALLOWED_REGEX" | sort -u)"
          if [ -z "$DOC_FILES" ]; then
            echo "No documentation files to commit."
            exit 0
          fi

          echo "$DOC_FILES" | xargs git add
          if ! git diff --staged --quiet; then
            git commit -m "docs: documentation updates from Claude request"
            git push
          else
            echo "No documentation changes to commit."
          fi
